# MCP Math Server with OAuth

OAuth-protected MCP server that provides basic arithmetic operations. Demonstrates MCP server authorization using OAuth 2.1 with Keycloak.

## Features

- OAuth 2.1 Protected Resource (RFC 9728)
- Token validation via Keycloak introspection
- Streamable HTTP transport
- Two arithmetic tools: `add_numbers` and `multiply_numbers`

## Prerequisites

- Python 3.11+
- Docker (for Keycloak)
- uv (Python package manager)

## Quick Start

### 1. Start Keycloak

```bash
docker run -p 127.0.0.1:8080:8080 \
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak start-dev
```

Note this is a blocking script, you will probably want to run the
configuration/server in a separate terminal.

### 2. Configure Keycloak (Mostly Automated)

Run the setup script to configure Keycloak:

```bash
cd math-server
./setup-keycloak.sh
```

This script will:
- ✅ Wait for Keycloak to be ready
- ✅ Create the `mcp:tools` client scope
- ✅ Configure audience mapper for `http://localhost:3000`
- ✅ Create `test-client` with client authentication
- ✅ Generate `.env` file with credentials

**Manual Setup Alternative:** If you prefer to configure Keycloak manually, follow the instructions at [MCP Authorization Tutorial - Keycloak Setup](https://modelcontextprotocol.io/docs/tutorials/security/authorization#keycloak-setup).

### 3. Install Dependencies

```bash
uv sync
```

### 4. Start the Server

```bash
uv run server.py
```

The server will start on `http://localhost:3000` with OAuth protection enabled.


### 5. Enable Trusted Hosts

In a browser, navigate to localhost:8080, and log in (the default username
and password are both "admin" as set above). Go to the "clients" panel on
the left, then the "Client Registration" tab, and select "Trusted Hosts".
Disable "Client URIs Must Match", and in the "Trusted Hosts" field add the IP address your client will be connecting from*, hit save.
 
*(if you're not sure your client IP, an easy way to find out is to attempt 
connecting from a client once - you'll get a 403 error, but if you look at
the keycloak logs you should see a warning log with a CLIENT_REGISTER_ERROR
with a specified IP address - that's the one to use).

## Configuration

The server is configured via environment variables in `.env` (auto-generated by setup script):

```bash
# OAuth Client (for token introspection)
OAUTH_CLIENT_ID=test-client
OAUTH_CLIENT_SECRET=<auto-generated>

# Server
HOST=localhost
PORT=3000

# Keycloak
AUTH_HOST=localhost
AUTH_PORT=8080
AUTH_REALM=master

# MCP
MCP_SCOPE=mcp:tools
TRANSPORT=streamable-http
```

## Available Tools

### add_numbers
Add two numbers together.

**Parameters:**
- `a` (float): First number
- `b` (float): Second number

**Returns:** Operation result with timestamp

### multiply_numbers
Multiply two numbers together.

**Parameters:**
- `x` (float): First number
- `y` (float): Second number

**Returns:** Operation result with timestamp

## OAuth Endpoints

The server exposes OAuth 2.0 Protected Resource Metadata (RFC 9728):

```
GET /.well-known/oauth-protected-resource
```

Example response:
```json
{
  "resource": "http://localhost:3000/",
  "authorization_servers": [
    "http://localhost:8080/realms/master/"
  ],
  "scopes_supported": ["mcp:tools"],
  "bearer_methods_supported": ["header"]
}
```

## Connecting Clients

To connect an MCP client to this server:

1. **HTTP Client with OAuth:** Use the `mcp-client/http_client` from this repository
2. **Other Clients:** Any MCP client that supports:
   - Streamable HTTP transport
   - OAuth 2.1 with Dynamic Client Registration (DCR)
   - PKCE (Proof Key for Code Exchange)

Example connection:
```bash
cd ../mcp-client
uv run http_client.py http://localhost:3000
```

On first run, a browser will open for OAuth authentication. Subsequent runs use cached tokens.

## Verification

Test that OAuth metadata is accessible:
```bash
curl http://localhost:3000/.well-known/oauth-protected-resource
```

Test Keycloak OpenID configuration:
```bash
curl http://localhost:8080/realms/master/.well-known/openid-configuration
```

## Troubleshooting

### Server returns 401 for all requests
- Verify `OAUTH_CLIENT_SECRET` is set correctly in `.env`
- Check Keycloak is running: `curl http://localhost:8080/health/ready`
- Verify test-client exists in Keycloak admin console

### Token introspection fails
- Check server logs for introspection endpoint errors
- Verify client credentials match Keycloak configuration
- Ensure `test-client` has service account enabled

### Client can't complete OAuth flow
- Add `*` to test-client redirect URIs in Keycloak
- Check client registration is enabled (setup script does this)
- Verify `mcp:tools` scope exists with audience mapper

## Security Notes

- This is a **development/demo setup** using Keycloak in dev mode
- The audience is hardcoded to `http://localhost:3000` for simplicity
- In production:
  - Use Keycloak in production mode with HTTPS
  - Configure proper audience validation based on resource parameter
  - Use strong client secrets
  - Enable proper CORS policies
  - Consider token expiration and refresh policies

## References

- [MCP Authorization Tutorial](https://modelcontextprotocol.io/docs/tutorials/security/authorization)
- [RFC 9728: OAuth 2.0 Protected Resource Metadata](https://datatracker.ietf.org/doc/html/rfc9728)
- [RFC 7662: OAuth 2.0 Token Introspection](https://datatracker.ietf.org/doc/html/rfc7662)
- [Keycloak Documentation](https://www.keycloak.org/documentation)
